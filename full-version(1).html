<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#a7d7e8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="日常记账">
    <title>日常记账</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/0eab2c2c0a9d4dd8ab76ff05deab1fcf~tplv-a9rns2rl98-image.image?rcl=20251229092651325D461E188D1E4632BD&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1769563626&x-signature=aELpI9ZJmJdwFvu58AVr9%2BTmDjg%3D" type="image/png">
    <link rel="apple-touch-icon" href="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/0eab2c2c0a9d4dd8ab76ff05deab1fcf~tplv-a9rns2rl98-image.image?rcl=20251229092651325D461E188D1E4632BD&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1769563626&x-signature=aELpI9ZJmJdwFvu58AVr9%2BTmDjg%3D">
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- 统一的 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#a7d7e8', // 马卡龙蓝
                        secondary: '#f8bbd9', // 马卡龙粉
                        neutral: '#f9f4f8', // 柔和中性色
                        'neutral-dark': '#94a3b8', // 深中性色
                        'expense': '#ff9eb8', // 马卡龙粉（支出色）
                        'income': '#9ed4e8', // 马卡龙蓝（收入色）
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .glass {
                background: rgba(255, 255, 255, 0.7);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            .shadow-soft {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            }
            .text-shadow {
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            }
            /* 移动端优化 */
            .touch-target {
                min-height: 44px;
                min-width: 44px;
            }
            .no-tap-highlight {
                -webkit-tap-highlight-color: transparent;
            }
            .input-focus {
                @apply focus:ring-2 focus:ring-primary focus:border-primary;
            }
            .btn-active {
                @apply active:scale-95 active:opacity-90;
            }
            /* 安全区域适配 */
            .safe-top {
                padding-top: env(safe-area-inset-top);
            }
            .safe-bottom {
                padding-bottom: env(safe-area-inset-bottom);
            }
            .safe-left {
                padding-left: env(safe-area-inset-left);
            }
            .safe-right {
                padding-right: env(safe-area-inset-right);
            }
        }
    </style>
</head>
<body class="bg-neutral font-sans">
    <!-- 主容器 -->
    <div class="max-w-md mx-auto min-h-screen bg-white shadow-soft relative pb-20">
        <!-- 顶部状态栏 -->
        <div class="bg-gradient-to-r from-primary to-secondary text-white p-4 shadow-md">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-shadow">日常记账</h1>
                <div class="text-sm opacity-90">
                    <span id="current-date">2025年7月21日</span>
                </div>
            </div>
        </div>

        <!-- 内容区域 -->
        <div class="p-4">
            <!-- 模块容器 -->
            <div id="module-container" class="animate-fade-in">
                <!-- 记账模块 -->
                <div id="record-module" class="block">
                    <!-- 快速记账卡片 -->
                    <div class="bg-white rounded-xl shadow-soft p-5 mb-6 animate-slide-up">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">快速记账</h2>
                            <div class="flex space-x-2">
                                <button id="expense-btn" class="px-4 py-2 bg-expense text-white rounded-lg text-sm font-medium shadow-sm hover:bg-pink-300 transition-colors">支出</button>
                                <button id="income-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium shadow-sm hover:bg-gray-300 transition-colors">收入</button>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">金额</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">¥</span>
                                <input type="number" id="amount" class="w-full pl-8 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="0.00" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="category" class="block text-sm font-medium text-gray-700 mb-1">分类</label>
                            <div class="grid grid-cols-4 gap-2" id="category-container">
                                <!-- 支出分类 -->
                                <div class="category-item expense-category active" data-category="餐饮">
                                    <div class="bg-pink-50 rounded-lg p-3 text-center cursor-pointer hover:bg-pink-100 transition-colors">
                                        <i class="fa fa-cutlery text-expense text-xl mb-1"></i>
                                        <p class="text-xs text-gray-700">餐饮</p>
                                    </div>
                                </div>
                                <div class="category-item expense-category" data-category="交通">
                                    <div class="bg-gray-50 rounded-lg p-3 text-center cursor-pointer hover:bg-pink-100 transition-colors">
                                        <i class="fa fa-car text-expense text-xl mb-1"></i>
                                        <p class="text-xs text-gray-700">交通</p>
                                    </div>
                                </div>
                                <div class="category-item expense-category" data-category="购物">
                                    <div class="bg-gray-50 rounded-lg p-3 text-center cursor-pointer hover:bg-pink-100 transition-colors">
                                        <i class="fa fa-shopping-bag text-expense text-xl mb-1"></i>
                                        <p class="text-xs text-gray-700">购物</p>
                                    </div>
                                </div>
                                <div class="category-item expense-category" data-category="娱乐">
                                    <div class="bg-gray-50 rounded-lg p-3 text-center cursor-pointer hover:bg-pink-100 transition-colors">
                                        <i class="fa fa-film text-expense text-xl mb-1"></i>
                                        <p class="text-xs text-gray-700">娱乐</p>
                                    </div>
                                </div>
                                <div class="category-item expense-category" data-category="居家">
                                    <div class="bg-gray-50 rounded-lg p-3 text-center cursor-pointer hover:bg-pink-100 transition-colors">
                                        <i class="fa fa-home text-expense text-xl mb-1"></i>
                                        <p class="text-xs text-gray-700">居家</p>
                                    </div>
                                </div>
                                <div class="category-item expense-category" data-category="医疗">
                                    <div class="bg-gray-50 rounded-lg p-3 text-center cursor-pointer hover:bg-pink-100 transition-colors">
                                        <i class="fa fa-medkit text-expense text-xl mb-1"></i>
                                        <p class="text-xs text-gray-700">医疗</p>
                                    </div>
                                </div>
                                <div class="category-item expense-category" data-category="教育">
                                    <div class="bg-gray-50 rounded-lg p-3 text-center cursor-pointer hover:bg-pink-100 transition-colors">
                                        <i class="fa fa-book text-expense text-xl mb-1"></i>
                                        <p class="text-xs text-gray-700">教育</p>
                                    </div>
                                </div>
                                <div class="category-item expense-category" data-category="其他">
                                    <div class="bg-gray-50 rounded-lg p-3 text-center cursor-pointer hover:bg-pink-100 transition-colors">
                                        <i class="fa fa-ellipsis-h text-expense text-xl mb-1"></i>
                                        <p class="text-xs text-gray-700">其他</p>
                                    </div>
                                </div>
                                
                                <!-- 收入分类 (初始隐藏) -->
                                <div class="category-item income-category hidden" data-category="工资">
                                    <div class="bg-blue-50 rounded-lg p-3 text-center cursor-pointer hover:bg-blue-100 transition-colors">
                                        <i class="fa fa-money text-income text-xl mb-1"></i>
                                        <p class="text-xs text-gray-700">工资</p>
                                    </div>
                                </div>
                                <div class="category-item income-category hidden" data-category="奖金">
                                    <div class="bg-gray-50 rounded-lg p-3 text-center cursor-pointer hover:bg-blue-100 transition-colors">
                                        <i class="fa fa-gift text-income text-xl mb-1"></i>
                                        <p class="text-xs text-gray-700">奖金</p>
                                    </div>
                                </div>
                                <div class="category-item income-category hidden" data-category="投资">
                                    <div class="bg-gray-50 rounded-lg p-3 text-center cursor-pointer hover:bg-blue-100 transition-colors">
                                        <i class="fa fa-line-chart text-income text-xl mb-1"></i>
                                        <p class="text-xs text-gray-700">投资</p>
                                    </div>
                                </div>
                                <div class="category-item income-category hidden" data-category="其他">
                                    <div class="bg-gray-50 rounded-lg p-3 text-center cursor-pointer hover:bg-blue-100 transition-colors">
                                        <i class="fa fa-ellipsis-h text-income text-xl mb-1"></i>
                                        <p class="text-xs text-gray-700">其他</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="date" class="block text-sm font-medium text-gray-700 mb-1">日期</label>
                            <input type="date" id="date" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" required>
                        </div>
                        
                        <div class="mb-6">
                            <label for="note" class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                            <textarea id="note" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" rows="2" placeholder="添加备注..."></textarea>
                        </div>
                        
                        <button id="add-record-btn" class="w-full bg-gradient-to-r from-primary to-secondary text-white py-3 rounded-lg font-medium shadow-md hover:opacity-90 transition-opacity transform hover:scale-[1.02] active:scale-[0.98]">
                            添加记录
                        </button>
                    </div>
                    
                    <!-- 最近记录 -->
                    <div class="bg-white rounded-xl shadow-soft p-5 animate-slide-up" style="animation-delay: 0.1s;">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">最近记录</h2>
                            <button id="view-all-records-btn" class="text-primary text-sm font-medium hover:underline">查看全部</button>
                        </div>
                        
                        <div id="recent-records" class="space-y-3">
                            <!-- 最近记录将通过 JavaScript 动态生成 -->
                            <div class="text-center text-gray-500 py-8">
                                暂无记录，开始添加第一条吧！
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 统计模块 -->
                <div id="stats-module" class="hidden">
                    <!-- 月度概览 -->
                    <div class="bg-white rounded-xl shadow-soft p-5 mb-6 animate-slide-up">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">月度概览</h2>
                            <div class="relative">
                                <select id="month-selector" class="appearance-none bg-gray-100 border-0 rounded-lg py-2 pl-3 pr-8 text-gray-700 cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary">
                                    <!-- 月份选项将通过 JavaScript 动态生成 -->
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <i class="fa fa-chevron-down text-xs"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-gray-50 rounded-lg p-4 text-center">
                                <p class="text-sm text-gray-500 mb-1">本月收入</p>
                                <p id="monthly-income" class="text-2xl font-bold text-income">¥0.00</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4 text-center">
                                <p class="text-sm text-gray-500 mb-1">本月支出</p>
                                <p id="monthly-expense" class="text-2xl font-bold text-expense">¥0.00</p>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <h3 class="text-sm font-medium text-gray-700 mb-3">收支趋势</h3>
                            <div class="h-64">
                                <canvas id="trend-chart"></canvas>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-sm font-medium text-gray-700 mb-3">支出分类占比</h3>
                            <div class="h-64">
                                <canvas id="category-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 年度统计 -->
                    <div class="bg-white rounded-xl shadow-soft p-5 animate-slide-up" style="animation-delay: 0.1s;">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">年度统计</h2>
                            <div class="relative">
                                <select id="year-selector" class="appearance-none bg-gray-100 border-0 rounded-lg py-2 pl-3 pr-8 text-gray-700 cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary">
                                    <!-- 年份选项将通过 JavaScript 动态生成 -->
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <i class="fa fa-chevron-down text-xs"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-gray-50 rounded-lg p-4 text-center">
                                <p class="text-sm text-gray-500 mb-1">年度收入</p>
                                <p id="yearly-income" class="text-2xl font-bold text-income">¥0.00</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4 text-center">
                                <p class="text-sm text-gray-500 mb-1">年度支出</p>
                                <p id="yearly-expense" class="text-2xl font-bold text-expense">¥0.00</p>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-sm font-medium text-gray-700 mb-3">月度对比</h3>
                            <div class="h-64">
                                <canvas id="yearly-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 预算模块 -->
                <div id="budget-module" class="hidden">
                    <!-- 预算设置 -->
                    <div class="bg-white rounded-xl shadow-soft p-5 mb-6 animate-slide-up">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">月度预算</h2>
                            <div class="relative">
                                <select id="budget-month-selector" class="appearance-none bg-gray-100 border-0 rounded-lg py-2 pl-3 pr-8 text-gray-700 cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary">
                                    <!-- 月份选项将通过 JavaScript 动态生成 -->
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <i class="fa fa-chevron-down text-xs"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label for="total-budget" class="block text-sm font-medium text-gray-700 mb-1">总预算</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">¥</span>
                                <input type="number" id="total-budget" class="w-full pl-8 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="0.00" step="0.01">
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <h3 class="text-sm font-medium text-gray-700 mb-3">预算使用情况</h3>
                            <div class="bg-gray-200 rounded-full h-4 mb-2">
                                <div id="budget-progress" class="bg-gradient-to-r from-primary to-secondary h-4 rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>已使用: <span id="used-budget">¥0.00</span></span>
                                <span>剩余: <span id="remaining-budget">¥0.00</span></span>
                            </div>
                        </div>
                        
                        <button id="save-budget-btn" class="w-full bg-gradient-to-r from-primary to-secondary text-white py-3 rounded-lg font-medium shadow-md hover:opacity-90 transition-opacity transform hover:scale-[1.02] active:scale-[0.98]">
                            保存预算
                        </button>
                    </div>
                    
                    <!-- 分类预算 -->
                    <div class="bg-white rounded-xl shadow-soft p-5 mb-6 animate-slide-up" style="animation-delay: 0.1s;">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">分类预算</h3>
                        
                        <div id="category-budgets" class="space-y-4">
                            <!-- 分类预算将通过 JavaScript 动态生成 -->
                        </div>
                        
                        <button id="save-category-budgets-btn" class="w-full mt-6 bg-gray-200 text-gray-700 py-3 rounded-lg font-medium shadow-sm hover:bg-gray-300 transition-colors">
                            保存分类预算
                        </button>
                    </div>
                    
                    <!-- 预算提醒 -->
                    <div class="bg-white rounded-xl shadow-soft p-5 animate-slide-up" style="animation-delay: 0.2s;">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">预算提醒</h3>
                        
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <input type="checkbox" id="budget-notification" class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
                                    <label for="budget-notification" class="ml-2 text-sm text-gray-700">启用预算提醒</label>
                                </div>
                            </div>
                            
                            <div class="pl-6">
                                <div class="mb-3">
                                    <label for="notification-threshold" class="block text-xs text-gray-500 mb-1">提醒阈值</label>
                                    <select id="notification-threshold" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                        <option value="50">50%</option>
                                        <option value="70">70%</option>
                                        <option value="80">80%</option>
                                        <option value="90">90%</option>
                                        <option value="100">100%</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AI分析模块 -->
                <div id="ai-module" class="hidden">
                    <!-- AI分析卡片 -->
                    <div class="bg-white rounded-xl shadow-soft p-5 mb-6 animate-slide-up">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center text-white mr-3">
                                <i class="fa fa-lightbulb-o text-lg"></i>
                            </div>
                            <h2 class="text-xl font-bold text-gray-800">智能分析</h2>
                        </div>
                        
                        <div id="ai-loading" class="hidden py-8">
                            <div class="flex justify-center mb-4">
                                <div class="w-10 h-10 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                            </div>
                            <p class="text-center text-gray-500">正在分析您的消费数据...</p>
                        </div>
                        
                        <div id="ai-results" class="space-y-6">
                            <!-- 消费习惯分析 -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-lg font-medium text-gray-800 mb-2">消费习惯分析</h3>
                                <p class="text-gray-600 text-sm">根据您的消费记录，您在餐饮类别上的支出占比最高，达到了<span class="font-bold text-expense">35%</span>。建议您可以考虑自己做饭，这样每月可以节省约<span class="font-bold text-income">¥500</span>。</p>
                            </div>
                            
                            <!-- 省钱建议 -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-lg font-medium text-gray-800 mb-2">省钱建议</h3>
                                <ul class="text-gray-600 text-sm space-y-2">
                                    <li class="flex items-start">
                                        <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                                        <span>您的交通支出较高，建议考虑使用公共交通工具或拼车服务。</span>
                                    </li>
                                    <li class="flex items-start">
                                        <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                                        <span>本月娱乐支出比上月增加了25%，可以适当控制娱乐消费。</span>
                                    </li>
                                    <li class="flex items-start">
                                        <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                                        <span>建议设置每周购物预算，避免冲动消费。</span>
                                    </li>
                                </ul>
                            </div>
                            
                            <!-- 消费趋势 -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-lg font-medium text-gray-800 mb-2">消费趋势</h3>
                                <p class="text-gray-600 text-sm">您的月度平均支出为<span class="font-bold text-expense">¥4,200</span>，比去年同期<span class="font-bold text-expense">上升了12%</span>。建议制定更详细的预算计划，控制支出增长。</p>
                            </div>
                        </div>
                        
                        <button id="refresh-ai-btn" class="w-full mt-6 bg-gradient-to-r from-primary to-secondary text-white py-3 rounded-lg font-medium shadow-md hover:opacity-90 transition-opacity transform hover:scale-[1.02] active:scale-[0.98]">
                            刷新分析
                        </button>
                    </div>
                    
                    <!-- 消费洞察 -->
                    <div class="bg-white rounded-xl shadow-soft p-5 animate-slide-up" style="animation-delay: 0.1s;">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">消费洞察</h2>
                        
                        <div class="space-y-4">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-base font-medium text-gray-800">最高支出类别</h3>
                                    <span class="text-xs bg-pink-50 text-expense px-2 py-1 rounded-full">35%</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-pink-50 flex items-center justify-center text-expense mr-3">
                                        <i class="fa fa-cutlery"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-800">餐饮</p>
                                        <p class="text-xs text-gray-500">¥1,470 / 月</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-base font-medium text-gray-800">支出增长最快</h3>
                                    <span class="text-xs bg-pink-50 text-expense px-2 py-1 rounded-full">+25%</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-pink-50 flex items-center justify-center text-expense mr-3">
                                        <i class="fa fa-film"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-800">娱乐</p>
                                        <p class="text-xs text-gray-500">¥840 / 月</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-base font-medium text-gray-800">建议控制支出</h3>
                                    <span class="text-xs bg-yellow-50 text-yellow-600 px-2 py-1 rounded-full">超预算</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-yellow-50 flex items-center justify-center text-yellow-600 mr-3">
                                        <i class="fa fa-shopping-bag"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-800">购物</p>
                                        <p class="text-xs text-gray-500">预算: ¥800 / 已用: ¥1,050</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 所有记录模块 -->
                <div id="all-records-module" class="hidden">
                    <div class="bg-white rounded-xl shadow-soft p-5 mb-6 animate-slide-up">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">所有记录</h2>
                            <div class="relative">
                                <select id="records-filter" class="appearance-none bg-gray-100 border-0 rounded-lg py-2 pl-3 pr-8 text-gray-700 cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary">
                                    <option value="all">全部</option>
                                    <option value="expense">支出</option>
                                    <option value="income">收入</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <i class="fa fa-chevron-down text-xs"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div id="all-records-list" class="space-y-3">
                            <!-- 所有记录将通过 JavaScript 动态生成 -->
                            <div class="text-center text-gray-500 py-8">
                                暂无记录
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部导航栏 -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg max-w-md mx-auto z-10 safe-bottom">
            <div class="flex justify-around">
                <button class="nav-btn flex flex-col items-center py-3 px-4 text-primary" data-module="record-module">
                    <i class="fa fa-plus-circle text-xl mb-1"></i>
                    <span class="text-xs">记账</span>
                </button>
                <button class="nav-btn flex flex-col items-center py-3 px-4 text-gray-500" data-module="stats-module">
                    <i class="fa fa-bar-chart text-xl mb-1"></i>
                    <span class="text-xs">统计</span>
                </button>
                <button class="nav-btn flex flex-col items-center py-3 px-4 text-gray-500" data-module="budget-module">
                    <i class="fa fa-pie-chart text-xl mb-1"></i>
                    <span class="text-xs">预算</span>
                </button>
                <button class="nav-btn flex flex-col items-center py-3 px-4 text-gray-500" data-module="ai-module">
                    <i class="fa fa-lightbulb-o text-xl mb-1"></i>
                    <span class="text-xs">分析</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- 确认对话框 -->
    <div id="confirm-dialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-5 max-w-xs w-full mx-4 animate-slide-up">
            <h3 class="text-lg font-bold text-gray-800 mb-3">确认删除</h3>
            <p class="text-gray-600 text-sm mb-5">确定要删除这条记录吗？此操作无法撤销。</p>
            <div class="flex space-x-3">
                <button id="cancel-delete-btn" class="flex-1 py-2.5 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors">取消</button>
                <button id="confirm-delete-btn" class="flex-1 py-2.5 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition-colors">删除</button>
            </div>
        </div>
    </div>

    <!-- 提示消息 -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 hidden">
        <span id="toast-message">操作成功</span>
    </div>

    <script>
        // 全局变量
        let records = JSON.parse(localStorage.getItem('expenseRecords')) || [];
        let budgets = JSON.parse(localStorage.getItem('budgets')) || {};
        let categoryBudgets = JSON.parse(localStorage.getItem('categoryBudgets')) || {};
        let currentRecordType = 'expense';
        let currentModule = 'record-module';
        let recordToDelete = null;
        let trendChart = null;
        let categoryChart = null;
        let yearlyChart = null;

        // 初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        function initApp() {
            updateCurrentDate();
            setupEventListeners();
            loadRecords();
            updateRecentRecords();
            setupDateInput();
            setupSelectors();
            loadBudgets();
            loadCategoryBudgets();
            loadNotificationSettings();
            // 初始化图表（在统计模块显示时会更新数据）
            initCharts();
        }

        // 更新当前日期
        function updateCurrentDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('zh-CN', options);
        }

        // 设置日期输入框默认值为今天
        function setupDateInput() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 记录类型切换
            document.getElementById('expense-btn').addEventListener('click', () => switchRecordType('expense'));
            document.getElementById('income-btn').addEventListener('click', () => switchRecordType('income'));

            // 分类选择
            document.querySelectorAll('.category-item').forEach(item => {
                item.addEventListener('click', function() {
                    const categoryType = this.classList.contains('expense-category') ? 'expense' : 'income';
                    document.querySelectorAll(`.${categoryType}-category`).forEach(cat => {
                        cat.classList.remove('active');
                        cat.querySelector('div').classList.remove('bg-pink-50', 'bg-blue-50');
                        cat.querySelector('div').classList.add('bg-gray-50');
                    });
                    this.classList.add('active');
                    this.querySelector('div').classList.remove('bg-gray-50');
                    this.querySelector('div').classList.add(categoryType === 'expense' ? 'bg-pink-50' : 'bg-blue-50');
                });
            });

            // 添加记录
            document.getElementById('add-record-btn').addEventListener('click', addRecord);

            // 导航按钮
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const module = this.dataset.module;
                    switchModule(module);
                });
            });

            // 查看全部记录
            document.getElementById('view-all-records-btn').addEventListener('click', function() {
                switchModule('all-records-module');
                updateAllRecords();
            });

            // 记录筛选
            document.getElementById('records-filter').addEventListener('change', updateAllRecords);

            // 月份和年份选择器
            document.getElementById('month-selector').addEventListener('change', updateStats);
            document.getElementById('year-selector').addEventListener('change', updateYearlyStats);
            document.getElementById('budget-month-selector').addEventListener('change', updateBudgetView);

            // 预算保存
            document.getElementById('save-budget-btn').addEventListener('click', saveBudget);
            document.getElementById('save-category-budgets-btn').addEventListener('click', saveCategoryBudgets);

            // 通知设置
            document.getElementById('budget-notification').addEventListener('change', saveNotificationSettings);
            document.getElementById('notification-threshold').addEventListener('change', saveNotificationSettings);

            // AI分析刷新
            document.getElementById('refresh-ai-btn').addEventListener('click', refreshAI);

            // 删除确认
            document.getElementById('cancel-delete-btn').addEventListener('click', function() {
                document.getElementById('confirm-dialog').classList.add('hidden');
                recordToDelete = null;
            });

            document.getElementById('confirm-delete-btn').addEventListener('click', deleteRecord);
        }

        // 切换记录类型
        function switchRecordType(type) {
            currentRecordType = type;
            
            if (type === 'expense') {
                document.getElementById('expense-btn').classList.remove('bg-gray-200', 'text-gray-700');
                document.getElementById('expense-btn').classList.add('bg-expense', 'text-white');
                document.getElementById('income-btn').classList.remove('bg-income', 'text-white');
                document.getElementById('income-btn').classList.add('bg-gray-200', 'text-gray-700');
                
                document.querySelectorAll('.expense-category').forEach(cat => cat.classList.remove('hidden'));
                document.querySelectorAll('.income-category').forEach(cat => cat.classList.add('hidden'));
                
                // 选择第一个支出分类
                const firstExpenseCategory = document.querySelector('.expense-category');
                if (firstExpenseCategory) {
                    firstExpenseCategory.click();
                }
            } else {
                document.getElementById('income-btn').classList.remove('bg-gray-200', 'text-gray-700');
                document.getElementById('income-btn').classList.add('bg-income', 'text-white');
                document.getElementById('expense-btn').classList.remove('bg-expense', 'text-white');
                document.getElementById('expense-btn').classList.add('bg-gray-200', 'text-gray-700');
                
                document.querySelectorAll('.income-category').forEach(cat => cat.classList.remove('hidden'));
                document.querySelectorAll('.expense-category').forEach(cat => cat.classList.add('hidden'));
                
                // 选择第一个收入分类
                const firstIncomeCategory = document.querySelector('.income-category');
                if (firstIncomeCategory) {
                    firstIncomeCategory.click();
                }
            }
        }

        // 添加记录
        function addRecord() {
            const amount = parseFloat(document.getElementById('amount').value);
            const date = document.getElementById('date').value;
            const note = document.getElementById('note').value;
            
            // 验证输入
            if (!amount || amount <= 0) {
                showToast('请输入有效的金额');
                return;
            }
            
            if (!date) {
                showToast('请选择日期');
                return;
            }
            
            // 获取选中的分类
            const activeCategory = document.querySelector(`.${currentRecordType}-category.active`);
            if (!activeCategory) {
                showToast('请选择分类');
                return;
            }
            
            const category = activeCategory.dataset.category;
            
            // 创建记录对象
            const record = {
                id: Date.now().toString(),
                type: currentRecordType,
                amount: amount,
                category: category,
                date: date,
                note: note,
                timestamp: new Date().toISOString()
            };
            
            // 添加到记录数组
            records.unshift(record);
            
            // 保存到本地存储
            saveRecords();
            
            // 更新UI
            updateRecentRecords();
            
            // 重置表单
            document.getElementById('amount').value = '';
            document.getElementById('note').value = '';
            
            // 显示成功提示
            showToast('记录添加成功');
            
            // 检查预算
            checkBudget();
        }

        // 保存记录到本地存储
        function saveRecords() {
            localStorage.setItem('expenseRecords', JSON.stringify(records));
        }

        // 加载记录
        function loadRecords() {
            records = JSON.parse(localStorage.getItem('expenseRecords')) || [];
        }

        // 更新最近记录
        function updateRecentRecords() {
            const recentRecordsContainer = document.getElementById('recent-records');
            const recentRecords = records.slice(0, 5);
            
            if (recentRecords.length === 0) {
                recentRecordsContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        暂无记录，开始添加第一条吧！
                    </div>
                `;
                return;
            }
            
            recentRecordsContainer.innerHTML = recentRecords.map(record => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full ${record.type === 'expense' ? 'bg-pink-50 text-expense' : 'bg-blue-50 text-income'} flex items-center justify-center mr-3">
                            <i class="fa ${getCategoryIcon(record.category, record.type)}"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-800">${record.category}</p>
                            <p class="text-xs text-gray-500">${formatDate(record.date)} ${record.note ? '· ' + record.note : ''}</p>
                        </div>
                    </div>
                    <span class="font-medium ${record.type === 'expense' ? 'text-expense' : 'text-income'}">${record.type === 'expense' ? '-' : '+'}¥${record.amount.toFixed(2)}</span>
                </div>
            `).join('');
        }

        // 更新所有记录
        function updateAllRecords() {
            const filter = document.getElementById('records-filter').value;
            let filteredRecords = records;
            
            if (filter !== 'all') {
                filteredRecords = records.filter(record => record.type === filter);
            }
            
            const allRecordsContainer = document.getElementById('all-records-list');
            
            if (filteredRecords.length === 0) {
                allRecordsContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        暂无记录
                    </div>
                `;
                return;
            }
            
            // 按日期分组
            const groupedRecords = {};
            filteredRecords.forEach(record => {
                const date = record.date;
                if (!groupedRecords[date]) {
                    groupedRecords[date] = [];
                }
                groupedRecords[date].push(record);
            });
            
            // 生成HTML
            let html = '';
            Object.keys(groupedRecords).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
                const dayRecords = groupedRecords[date];
                const dayTotal = dayRecords.reduce((sum, record) => {
                    return sum + (record.type === 'income' ? record.amount : -record.amount);
                }, 0);
                
                html += `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-sm font-medium text-gray-700">${formatDate(date)}</h3>
                            <span class="text-xs ${dayTotal >= 0 ? 'text-income' : 'text-expense'}">${dayTotal >= 0 ? '+' : ''}¥${dayTotal.toFixed(2)}</span>
                        </div>
                        <div class="space-y-2">
                `;
                
                dayRecords.forEach(record => {
                    html += `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full ${record.type === 'expense' ? 'bg-pink-50 text-expense' : 'bg-blue-50 text-income'} flex items-center justify-center mr-3">
                                    <i class="fa ${getCategoryIcon(record.category, record.type)}"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-800">${record.category}</p>
                                    <p class="text-xs text-gray-500">${record.note || ''}</p>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <span class="font-medium ${record.type === 'expense' ? 'text-expense' : 'text-income'} mr-3">${record.type === 'expense' ? '-' : '+'}¥${record.amount.toFixed(2)}</span>
                                <button class="text-gray-400 hover:text-red-500 delete-record" data-id="${record.id}">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            allRecordsContainer.innerHTML = html;
            
            // 添加删除按钮事件
            document.querySelectorAll('.delete-record').forEach(btn => {
                btn.addEventListener('click', function() {
                    const recordId = this.dataset.id;
                    recordToDelete = recordId;
                    document.getElementById('confirm-dialog').classList.remove('hidden');
                });
            });
        }

        // 删除记录
        function deleteRecord() {
            if (recordToDelete) {
                records = records.filter(record => record.id !== recordToDelete);
                saveRecords();
                updateRecentRecords();
                updateAllRecords();
                updateStats();
                updateBudgetView();
                document.getElementById('confirm-dialog').classList.add('hidden');
                showToast('记录已删除');
                recordToDelete = null;
            }
        }

        // 切换模块
        function switchModule(moduleId) {
            // 隐藏所有模块
            document.querySelectorAll('#module-container > div').forEach(module => {
                module.classList.add('hidden');
            });
            
            // 显示选中的模块
            document.getElementById(moduleId).classList.remove('hidden');
            
            // 更新导航按钮状态
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.dataset.module === moduleId) {
                    btn.classList.add('text-primary');
                    btn.classList.remove('text-gray-500');
                } else {
                    btn.classList.remove('text-primary');
                    btn.classList.add('text-gray-500');
                }
            });
            
            currentModule = moduleId;
            
            // 根据模块更新数据
            if (moduleId === 'stats-module') {
                updateStats();
            } else if (moduleId === 'budget-module') {
                updateBudgetView();
            } else if (moduleId === 'all-records-module') {
                updateAllRecords();
            }
        }

        // 设置选择器
        function setupSelectors() {
            setupMonthSelector('month-selector');
            setupMonthSelector('budget-month-selector');
            setupYearSelector('year-selector');
        }

        // 设置月份选择器
        function setupMonthSelector(selectorId) {
            const selector = document.getElementById(selectorId);
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            selector.innerHTML = '';
            
            // 生成过去12个月和未来3个月的选项
            for (let i = -12; i <= 3; i++) {
                const date = new Date(currentYear, currentMonth + i, 1);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const monthName = date.toLocaleDateString('zh-CN', { month: 'long' });
                const value = `${year}-${month.toString().padStart(2, '0')}`;
                
                const option = document.createElement('option');
                option.value = value;
                option.textContent = `${year}年${monthName}`;
                
                if (i === 0) {
                    option.selected = true;
                }
                
                selector.appendChild(option);
            }
        }

        // 设置年份选择器
        function setupYearSelector(selectorId) {
            const selector = document.getElementById(selectorId);
            const now = new Date();
            const currentYear = now.getFullYear();
            
            selector.innerHTML = '';
            
            // 生成过去3年和未来1年的选项
            for (let i = -3; i <= 1; i++) {
                const year = currentYear + i;
                
                const option = document.createElement('option');
                option.value = year.toString();
                option.textContent = `${year}年`;
                
                if (i === 0) {
                    option.selected = true;
                }
                
                selector.appendChild(option);
            }
        }

        // 更新统计数据
        function updateStats() {
            const monthSelector = document.getElementById('month-selector');
            const selectedMonth = monthSelector.value;
            const [year, month] = selectedMonth.split('-');
            
            // 筛选当月记录
            const monthRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getFullYear() === parseInt(year) && 
                       recordDate.getMonth() + 1 === parseInt(month);
            });
            
            // 计算收入和支出
            const monthlyIncome = monthRecords
                .filter(record => record.type === 'income')
                .reduce((sum, record) => sum + record.amount, 0);
                
            const monthlyExpense = monthRecords
                .filter(record => record.type === 'expense')
                .reduce((sum, record) => sum + record.amount, 0);
            
            // 更新显示
            document.getElementById('monthly-income').textContent = `¥${monthlyIncome.toFixed(2)}`;
            document.getElementById('monthly-expense').textContent = `¥${monthlyExpense.toFixed(2)}`;
            
            // 更新趋势图
            updateTrendChart(year, month);
            
            // 更新分类图
            updateCategoryChart(monthRecords);
        }

        // 更新年度统计
        function updateYearlyStats() {
            const yearSelector = document.getElementById('year-selector');
            const selectedYear = parseInt(yearSelector.value);
            
            // 筛选当年记录
            const yearRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getFullYear() === selectedYear;
            });
            
            // 计算收入和支出
            const yearlyIncome = yearRecords
                .filter(record => record.type === 'income')
                .reduce((sum, record) => sum + record.amount, 0);
                
            const yearlyExpense = yearRecords
                .filter(record => record.type === 'expense')
                .reduce((sum, record) => sum + record.amount, 0);
            
            // 更新显示
            document.getElementById('yearly-income').textContent = `¥${yearlyIncome.toFixed(2)}`;
            document.getElementById('yearly-expense').textContent = `¥${yearlyExpense.toFixed(2)}`;
            
            // 更新年度图表
            updateYearlyChart(selectedYear);
        }

        // 初始化图表
        function initCharts() {
            // 趋势图
            const trendCtx = document.getElementById('trend-chart').getContext('2d');
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '收入',
                            data: [],
                            borderColor: '#9ed4e8',
                            backgroundColor: 'rgba(158, 212, 232, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: '支出',
                            data: [],
                            borderColor: '#ff9eb8',
                            backgroundColor: 'rgba(255, 158, 184, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value;
                                }
                            }
                        }
                    }
                }
            });
            
            // 分类图
            const categoryCtx = document.getElementById('category-chart').getContext('2d');
            categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#ff9eb8', '#ffa7b6', '#ffb3c4', '#ffbfd2', 
                            '#ffcbda', '#ffd7e8', '#ffe3f0', '#fff0f8'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
            
            // 年度图
            const yearlyCtx = document.getElementById('yearly-chart').getContext('2d');
            yearlyChart = new Chart(yearlyCtx, {
                type: 'bar',
                data: {
                    labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                    datasets: [
                        {
                            label: '收入',
                            data: Array(12).fill(0),
                            backgroundColor: '#9ed4e8',
                            borderRadius: 4
                        },
                        {
                            label: '支出',
                            data: Array(12).fill(0),
                            backgroundColor: '#ff9eb8',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 更新趋势图
        function updateTrendChart(year, month) {
            const daysInMonth = new Date(year, month, 0).getDate();
            const labels = Array.from({length: daysInMonth}, (_, i) => i + 1);
            const incomeData = Array(daysInMonth).fill(0);
            const expenseData = Array(daysInMonth).fill(0);
            
            // 筛选当月记录
            const monthRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getFullYear() === parseInt(year) && 
                       recordDate.getMonth() + 1 === parseInt(month);
            });
            
            // 按日期分组数据
            monthRecords.forEach(record => {
                const day = new Date(record.date).getDate() - 1;
                if (record.type === 'income') {
                    incomeData[day] += record.amount;
                } else {
                    expenseData[day] += record.amount;
                }
            });
            
            // 更新图表数据
            trendChart.data.labels = labels;
            trendChart.data.datasets[0].data = incomeData;
            trendChart.data.datasets[1].data = expenseData;
            trendChart.update();
        }

        // 更新分类图
        function updateCategoryChart(monthRecords) {
            const expenseRecords = monthRecords.filter(record => record.type === 'expense');
            const categoryData = {};
            
            // 按分类分组数据
            expenseRecords.forEach(record => {
                if (!categoryData[record.category]) {
                    categoryData[record.category] = 0;
                }
                categoryData[record.category] += record.amount;
            });
            
            // 准备图表数据
            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);
            
            // 更新图表
            categoryChart.data.labels = labels;
            categoryChart.data.datasets[0].data = data;
            categoryChart.update();
        }

        // 更新年度图表
        function updateYearlyChart(year) {
            const incomeData = Array(12).fill(0);
            const expenseData = Array(12).fill(0);
            
            // 筛选当年记录
            const yearRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getFullYear() === year;
            });
            
            // 按月份分组数据
            yearRecords.forEach(record => {
                const month = new Date(record.date).getMonth();
                if (record.type === 'income') {
                    incomeData[month] += record.amount;
                } else {
                    expenseData[month] += record.amount;
                }
            });
            
            // 更新图表
            yearlyChart.data.datasets[0].data = incomeData;
            yearlyChart.data.datasets[1].data = expenseData;
            yearlyChart.update();
        }

        // 加载预算
        function loadBudgets() {
            budgets = JSON.parse(localStorage.getItem('budgets')) || {};
        }

        // 保存预算
        function saveBudget() {
            const budgetMonthSelector = document.getElementById('budget-month-selector');
            const selectedMonth = budgetMonthSelector.value;
            const totalBudgetInput = document.getElementById('total-budget');
            const totalBudget = parseFloat(totalBudgetInput.value);
            
            if (isNaN(totalBudget) || totalBudget <= 0) {
                showToast('请输入有效的预算金额');
                return;
            }
            
            // 保存预算
            budgets[selectedMonth] = totalBudget;
            localStorage.setItem('budgets', JSON.stringify(budgets));
            
            // 更新预算视图
            updateBudgetView();
            
            showToast('预算保存成功');
        }

        // 更新预算视图
        function updateBudgetView() {
            const budgetMonthSelector = document.getElementById('budget-month-selector');
            const selectedMonth = budgetMonthSelector.value;
            const [year, month] = selectedMonth.split('-');
            
            // 获取当月预算
            const totalBudget = budgets[selectedMonth] || 0;
            document.getElementById('total-budget').value = totalBudget;
            
            // 筛选当月支出记录
            const monthExpenseRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return record.type === 'expense' &&
                       recordDate.getFullYear() === parseInt(year) && 
                       recordDate.getMonth() + 1 === parseInt(month);
            });
            
            // 计算已使用预算
            const usedBudget = monthExpenseRecords.reduce((sum, record) => sum + record.amount, 0);
            
            // 计算剩余预算
            const remainingBudget = totalBudget - usedBudget;
            
            // 更新显示
            document.getElementById('used-budget').textContent = `¥${usedBudget.toFixed(2)}`;
            document.getElementById('remaining-budget').textContent = `¥${remainingBudget.toFixed(2)}`;
            
            // 更新进度条
            const progressPercent = totalBudget > 0 ? (usedBudget / totalBudget) * 100 : 0;
            document.getElementById('budget-progress').style.width = `${Math.min(progressPercent, 100)}%`;
            
            // 如果超预算，进度条变红
            if (progressPercent > 100) {
                document.getElementById('budget-progress').classList.remove('bg-gradient-to-r', 'from-primary', 'to-secondary');
                document.getElementById('budget-progress').classList.add('bg-red-500');
            } else {
                document.getElementById('budget-progress').classList.add('bg-gradient-to-r', 'from-primary', 'to-secondary');
                document.getElementById('budget-progress').classList.remove('bg-red-500');
            }
            
            // 更新分类预算
            updateCategoryBudgetsView(selectedMonth);
        }

        // 加载分类预算
        function loadCategoryBudgets() {
            categoryBudgets = JSON.parse(localStorage.getItem('categoryBudgets')) || {};
        }

        // 更新分类预算视图
        function updateCategoryBudgetsView(month) {
            const categoryBudgetsContainer = document.getElementById('category-budgets');
            const expenseCategories = ['餐饮', '交通', '购物', '娱乐', '居家', '医疗', '教育', '其他'];
            
            // 获取当月分类预算
            const monthCategoryBudgets = categoryBudgets[month] || {};
            
            // 筛选当月支出记录
            const [year, monthNum] = month.split('-');
            const monthExpenseRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return record.type === 'expense' &&
                       recordDate.getFullYear() === parseInt(year) && 
                       recordDate.getMonth() + 1 === parseInt(monthNum);
            });
            
            // 按分类计算已使用金额
            const categoryUsage = {};
            expenseCategories.forEach(cat => categoryUsage[cat] = 0);
            monthExpenseRecords.forEach(record => {
                if (categoryUsage.hasOwnProperty(record.category)) {
                    categoryUsage[record.category] += record.amount;
                }
            });
            
            // 生成HTML
            categoryBudgetsContainer.innerHTML = expenseCategories.map(category => {
                const budget = monthCategoryBudgets[category] || 0;
                const usage = categoryUsage[category] || 0;
                const percent = budget > 0 ? (usage / budget) * 100 : 0;
                
                return `
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-pink-50 flex items-center justify-center text-expense mr-2">
                                    <i class="fa ${getCategoryIcon(category, 'expense')} text-sm"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-700">${category}</span>
                            </div>
                            <span class="text-xs ${usage > budget ? 'text-red-500' : 'text-gray-500'}">
                                ¥${usage.toFixed(0)} / ¥${budget.toFixed(0)}
                            </span>
                        </div>
                        <div class="bg-gray-200 rounded-full h-2 mb-2">
                            <div class="h-2 rounded-full ${percent > 100 ? 'bg-red-500' : 'bg-expense'}" style="width: ${Math.min(percent, 100)}%"></div>
                        </div>
                        <input type="number" class="category-budget-input w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" 
                               data-category="${category}" 
                               value="${budget}" 
                               placeholder="设置预算">
                    </div>
                `;
            }).join('');
            
            // 添加输入事件
            document.querySelectorAll('.category-budget-input').forEach(input => {
                input.addEventListener('change', function() {
                    const category = this.dataset.category;
                    const value = parseFloat(this.value) || 0;
                    
                    if (!categoryBudgets[month]) {
                        categoryBudgets[month] = {};
                    }
                    
                    categoryBudgets[month][category] = value;
                });
            });
        }

        // 保存分类预算
        function saveCategoryBudgets() {
            const budgetMonthSelector = document.getElementById('budget-month-selector');
            const selectedMonth = budgetMonthSelector.value;
            
            localStorage.setItem('categoryBudgets', JSON.stringify(categoryBudgets));
            
            // 更新视图
            updateCategoryBudgetsView(selectedMonth);
            
            showToast('分类预算保存成功');
        }

        // 加载通知设置
        function loadNotificationSettings() {
            const settings = JSON.parse(localStorage.getItem('notificationSettings')) || {
                enabled: false,
                threshold: 80
            };
            
            document.getElementById('budget-notification').checked = settings.enabled;
            document.getElementById('notification-threshold').value = settings.threshold;
        }

        // 保存通知设置
        function saveNotificationSettings() {
            const settings = {
                enabled: document.getElementById('budget-notification').checked,
                threshold: parseInt(document.getElementById('notification-threshold').value)
            };
            
            localStorage.setItem('notificationSettings', JSON.stringify(settings));
            
            showToast('通知设置已保存');
        }

        // 检查预算
        function checkBudget() {
            const settings = JSON.parse(localStorage.getItem('notificationSettings')) || {
                enabled: false,
                threshold: 80
            };
            
            if (!settings.enabled) return;
            
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
            const totalBudget = budgets[currentMonth] || 0;
            
            if (totalBudget <= 0) return;
            
            // 筛选当月支出记录
            const monthExpenseRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return record.type === 'expense' &&
                       recordDate.getFullYear() === now.getFullYear() && 
                       recordDate.getMonth() === now.getMonth();
            });
            
            // 计算已使用预算
            const usedBudget = monthExpenseRecords.reduce((sum, record) => sum + record.amount, 0);
            
            // 计算使用百分比
            const usedPercent = (usedBudget / totalBudget) * 100;
            
            // 如果超过阈值，显示通知
            if (usedPercent >= settings.threshold) {
                showBudgetNotification(usedPercent, settings.threshold);
            }
        }

        // 显示预算通知
        function showBudgetNotification(usedPercent, threshold) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('预算提醒', {
                    body: `您本月已使用${usedPercent.toFixed(0)}%的预算，超过了${threshold}%的提醒阈值。`,
                    icon: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/0eab2c2c0a9d4dd8ab76ff05deab1fcf~tplv-a9rns2rl98-image.image?rcl=20251229092651325D461E188D1E4632BD&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1769563626&x-signature=aELpI9ZJmJdwFvu58AVr9%2BTmDjg%3D'
                });
            } else if ('Notification' in window && Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        new Notification('预算提醒', {
                            body: `您本月已使用${usedPercent.toFixed(0)}%的预算，超过了${threshold}%的提醒阈值。`,
                            icon: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/0eab2c2c0a9d4dd8ab76ff05deab1fcf~tplv-a9rns2rl98-image.image?rcl=20251229092651325D461E188D1E4632BD&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1769563626&x-signature=aELpI9ZJmJdwFvu58AVr9%2BTmDjg%3D'
                        });
                    }
                });
            }
            
            // 同时显示应用内提示
            showToast(`预算提醒：已使用${usedPercent.toFixed(0)}%的预算`);
        }

        // 刷新AI分析
        function refreshAI() {
            const aiLoading = document.getElementById('ai-loading');
            const aiResults = document.getElementById('ai-results');
            
            // 显示加载状态
            aiLoading.classList.remove('hidden');
            aiResults.classList.add('hidden');
            
            // 模拟AI分析过程
            setTimeout(() => {
                // 隐藏加载状态，显示结果
                aiLoading.classList.add('hidden');
                aiResults.classList.remove('hidden');
                
                // 更新AI分析结果（这里使用模拟数据，实际应用中可以根据真实数据生成）
                updateAIResults();
                
                showToast('AI分析已更新');
            }, 1500);
        }

        // 更新AI分析结果
        function updateAIResults() {
            // 计算最近3个月的平均支出
            const now = new Date();
            const threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 3, 1);
            
            const recentRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return record.type === 'expense' && recordDate >= threeMonthsAgo;
            });
            
            const totalExpense = recentRecords.reduce((sum, record) => sum + record.amount, 0);
            const avgMonthlyExpense = totalExpense / 3;
            
            // 按分类统计支出
            const categoryExpenses = {};
            recentRecords.forEach(record => {
                if (!categoryExpenses[record.category]) {
                    categoryExpenses[record.category] = 0;
                }
                categoryExpenses[record.category] += record.amount;
            });
            
            // 找出最高支出分类
            let highestCategory = '';
            let highestAmount = 0;
            let highestPercent = 0;
            
            Object.keys(categoryExpenses).forEach(category => {
                const amount = categoryExpenses[category];
                const percent = (amount / totalExpense) * 100;
                
                if (amount > highestAmount) {
                    highestAmount = amount;
                    highestCategory = category;
                    highestPercent = percent;
                }
            });
            
            // 计算可能的节省金额（假设自己做饭可以节省30%的餐饮支出）
            const possibleSavings = categoryExpenses['餐饮'] ? categoryExpenses['餐饮'] * 0.3 : 0;
            
            // 更新AI分析结果
            const aiResults = document.getElementById('ai-results');
            
            aiResults.innerHTML = `
                <!-- 消费习惯分析 -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-lg font-medium text-gray-800 mb-2">消费习惯分析</h3>
                    <p class="text-gray-600 text-sm">根据您的消费记录，您在${highestCategory}类别上的支出占比最高，达到了<span class="font-bold text-expense">${highestPercent.toFixed(0)}%</span>。建议您可以考虑自己做饭，这样每月可以节省约<span class="font-bold text-income">¥${possibleSavings.toFixed(0)}</span>。</p>
                </div>
                
                <!-- 省钱建议 -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-lg font-medium text-gray-800 mb-2">省钱建议</h3>
                    <ul class="text-gray-600 text-sm space-y-2">
                        <li class="flex items-start">
                            <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                            <span>您的交通支出较高，建议考虑使用公共交通工具或拼车服务。</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                            <span>本月娱乐支出比上月增加了25%，可以适当控制娱乐消费。</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                            <span>建议设置每周购物预算，避免冲动消费。</span>
                        </li>
                    </ul>
                </div>
                
                <!-- 消费趋势 -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-lg font-medium text-gray-800 mb-2">消费趋势</h3>
                    <p class="text-gray-600 text-sm">您的月度平均支出为<span class="font-bold text-expense">¥${avgMonthlyExpense.toFixed(0)}</span>，比去年同期<span class="font-bold text-expense">上升了12%</span>。建议制定更详细的预算计划，控制支出增长。</p>
                </div>
            `;
            
            // 更新消费洞察
            updateConsumptionInsights(categoryExpenses, totalExpense, avgMonthlyExpense);
        }

        // 更新消费洞察
        function updateConsumptionInsights(categoryExpenses, totalExpense, avgMonthlyExpense) {
            // 找出最高支出类别
            let highestCategory = '';
            let highestAmount = 0;
            let highestPercent = 0;
            
            Object.keys(categoryExpenses).forEach(category => {
                const amount = categoryExpenses[category];
                const percent = (amount / totalExpense) * 100;
                
                if (amount > highestAmount) {
                    highestAmount = amount;
                    highestCategory = category;
                    highestPercent = percent;
                }
            });
            
            // 找出增长最快的类别（这里使用模拟数据）
            const fastestGrowthCategory = '娱乐';
            const fastestGrowthPercent = 25;
            const fastestGrowthAmount = categoryExpenses['娱乐'] || 840;
            
            // 找出超预算的类别
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
            const monthCategoryBudgets = categoryBudgets[currentMonth] || {};
            
            let overBudgetCategory = '';
            let overBudgetAmount = 0;
            let overBudgetLimit = 0;
            
            Object.keys(categoryExpenses).forEach(category => {
                const budget = monthCategoryBudgets[category] || 0;
                const amount = categoryExpenses[category];
                
                if (budget > 0 && amount > budget && amount - budget > overBudgetAmount - overBudgetLimit) {
                    overBudgetCategory = category;
                    overBudgetAmount = amount;
                    overBudgetLimit = budget;
                }
            });
            
            // 如果没有超预算的类别，使用默认值
            if (!overBudgetCategory) {
                overBudgetCategory = '购物';
                overBudgetAmount = 1050;
                overBudgetLimit = 800;
            }
            
            // 更新消费洞察
            const consumptionInsights = document.querySelector('#ai-module .bg-white:nth-child(2) .space-y-4');
            
            consumptionInsights.innerHTML = `
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-base font-medium text-gray-800">最高支出类别</h3>
                        <span class="text-xs bg-pink-50 text-expense px-2 py-1 rounded-full">${highestPercent.toFixed(0)}%</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-pink-50 flex items-center justify-center text-expense mr-3">
                            <i class="fa ${getCategoryIcon(highestCategory, 'expense')}"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-800">${highestCategory}</p>
                            <p class="text-xs text-gray-500">¥${highestAmount.toFixed(0)} / 月</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-base font-medium text-gray-800">支出增长最快</h3>
                        <span class="text-xs bg-pink-50 text-expense px-2 py-1 rounded-full">+${fastestGrowthPercent}%</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-pink-50 flex items-center justify-center text-expense mr-3">
                            <i class="fa ${getCategoryIcon(fastestGrowthCategory, 'expense')}"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-800">${fastestGrowthCategory}</p>
                            <p class="text-xs text-gray-500">¥${fastestGrowthAmount.toFixed(0)} / 月</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-base font-medium text-gray-800">建议控制支出</h3>
                        <span class="text-xs bg-yellow-50 text-yellow-600 px-2 py-1 rounded-full">超预算</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-yellow-50 flex items-center justify-center text-yellow-600 mr-3">
                            <i class="fa ${getCategoryIcon(overBudgetCategory, 'expense')}"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-800">${overBudgetCategory}</p>
                            <p class="text-xs text-gray-500">预算: ¥${overBudgetLimit.toFixed(0)} / 已用: ¥${overBudgetAmount.toFixed(0)}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // 获取分类图标
        function getCategoryIcon(category, type) {
            const icons = {
                // 支出分类图标
                '餐饮': 'fa-cutlery',
                '交通': 'fa-car',
                '购物': 'fa-shopping-bag',
                '娱乐': 'fa-film',
                '居家': 'fa-home',
                '医疗': 'fa-medkit',
                '教育': 'fa-book',
                '其他': 'fa-ellipsis-h',
                // 收入分类图标
                '工资': 'fa-money',
                '奖金': 'fa-gift',
                '投资': 'fa-line-chart'
            };
            
            return icons[category] || 'fa-ellipsis-h';
        }

        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' });
        }

        // 显示提示消息
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // 注册Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js')
                    .then(function(registration) {
                        console.log('Service Worker 注册成功:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Service Worker 注册失败:', error);
                    });
            });
        }
    </script>
</body>
</html>